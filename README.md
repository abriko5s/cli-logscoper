# LogScoper

![img.png](img.png)

## О проекте

В этом репозитории реализован CLI (консольная утилита) -- инструмент, которые читает входящие логи. Задание было в курсе "Язык программирования Python (продвинутый курс)". 
По итогам проверки лектор выставил 10/10.

## Функционал

Утилита запускается так:


```
python -m logscoper <команда> [опции]
```

1. Команда `stats` считает статистику по файлу логов.

* `total` - сколько всего строк/запросов прочитано
* `status` - словарь с количеством запросов по каждому HTTP-коду (например: {200: 69 , 404: 96, 405: 3}).
* `rt_avg_ms` - среднее время ответа (в миллисекундах, округлять до 2 знаков). Если нет данных о времени ответа — вывести `n/a`.
* `rt_p95_ms` — 95-й перцентиль времени ответа
* `rt_p99_ms` - 99-й перцинтель времени ответа
* `top_paths` — список из N самых популярных путей по файлу логов (например: ["/index.html", "/login", "/api"]), вместе с количеством запросов.


**Опции:**
*`--path access.log` — путь к файлу лога.  
*`--top 5` — сколько самых популярных URL выводить (по умолчанию 10).  
* `--since 2025-09-10T12:00:00+00:00` — учитывать только записи после этой даты/времени.  
* `--until 2025-09-10T13:00:00+00:00` — учитывать только записи до этого момента.  
* `--status 5xx` или `--status 200,404` — фильтр по статусам.  
* `--grep "regex"` — фильтр по пути (например, `--grep "^/api"`).  
*`--json` — вывод в формате JSON (иначе — текстом).

**Примеры:**

```bash
python -m logscoper stats --path access.log --top 3
```

Ответ:
Обычный текст если не указали флаг.

```
Total: 5
By status:
  200: 3
  302: 1
  500: 1
Avg RT (ms): 334.00
P95 RT (ms): 900.00
Top paths:
      1  /index.html
      1  /style.css
      1  /login
```

С флагом:

```bash
python -m logscoper stats --path access.log --top 3 --json
```


```
{
  "total": 5,
  "status": {"200": 3, "302": 1, "500": 1},
  "rt_avg_ms": 334.0,
  "rt_p95_ms": 900.0,
  "top_paths": [["/index.html", 1], ["/style.css", 1], ["/login", 1]]
}
```


**Пример 2**.

**Пример входных данных (`access.log`):**

```nginx
127.0.0.1 - - [10/Oct/2000:13:55:36 +0000] "GET /index.html HTTP/1.1" 200 2326 "-" "UA" 0.120
127.0.0.1 - - [10/Oct/2000:13:55:37 +0000] "GET /login HTTP/1.1" 302 0 "-" "UA" 0.250
127.0.0.1 - - [10/Oct/2000:13:55:38 +0000] "POST /api/v1/users HTTP/1.1" 500 12 "-" "UA" 0.900
127.0.0.1 - - [10/Oct/2000:13:55:40 +0000] "GET /index.html HTTP/1.1" 200 2326 "-" "UA" 0.110
```
Запрос:
```
python -m logscoper stats --path access.log --top 2
```
Ответ:
```
Total: 4
By status:
  200: 2
  302: 1
  500: 1
Avg RT (ms): 345.00
P95 RT (ms): 900.00
P99 RT (ms): 900.00
Top paths:
      2  /index.html
      1  /login

```

C `--json`:

Запрос:
```
python -m logscoper stats --path access.log --json --top 2
```
Ответ:

```json
{
  "total": 4,
  "status": {"200": 2, "302": 1, "500": 1},
  "rt_avg_ms": 345.0,
  "rt_p95_ms": 900.0,
  "rt_p99_ms": 900.0,
  "top_paths": [["/index.html", 2], ["/login", 1]]
}
```

2. Команда `filter` выводит только те строки, которые подходят под условия фильтрации.

Формат вывода: каждая подходящая запись печатается в нормализованном виде одной строкой:

**Опции:**
- `--path access.log` — путь к файлу лога.
- `--since 2025-09-10T12:00:00+00:00` — учитывать записи **начиная с** этой даты/времени (включительно).
- `--until 2025-09-10T13:00:00+00:00` — учитывать записи **до** этого момента (не включая).
- `--status 5xx` или `--status 200,404` — фильтр по статусам.
- `--grep "regex"` — фильтр по пути (регулярное выражение).
- `--out filtered.txt` — если задано, писать вывод в файл; иначе — в stdout.

**Примеры запуска:**

**Пример 1**


**Пример входных данных (`access.log`):**

```
127.0.0.1 - - [10/Oct/2000:13:55:36 +0000] "GET /index.html HTTP/1.1" 200 2326 "-" "UA" 0.120
127.0.0.1 - - [10/Oct/2000:13:55:40 +0000] "GET /boom HTTP/1.1" 500 0 "-" "UA" 0.900
```
Запрос:

```bash
python -m logscoper filter --path access.log --status 5xx
```

Ответ:

```
2000-10-10T13:55:38+00:00 127.0.0.1 POST /api/v1/users 500 12 rt=0.9
```

C `--grep`:
Запрос:
```
python -m logscope filter --path access.log --grep "^/index"
```

Ответ:
```
2000`-10-10T13:55:36+00:00 127.0.0.1 GET /index.html 200 2326 rt=0.12
```

C `--since`:

Запрос:
```shell
python -m logscoper filter --path access.log --since 2000-10-10T13:55:37+00:00
```

Ответ:

```text
2000-10-10T13:55:37+00:00 127.0.0.1 GET /login 302 0 rt=0.25
2000-10-10T13:55:38+00:00 127.0.0.1 POST /api/v1/users 500 12 rt=0.9
2000-10-10T13:55:40+00:00 127.0.0.1 GET /index.html 200 2326 rt=0.11
```

Фильтр по регулярке:

Запрос:

```shell
python -m logscoper filter --path access.log --grep "^/api"
```

Ответ:

```
2000-10-10T13:55:38+00:00 127.0.0.1 POST /api/v1/users 500 12 rt=0.9
```


3. Команда `hist` строит гистограмму по времени ответа (request_time). Каждый запрос попадает в “корзину” шириной bucket-ms миллисекунд.

- `--path access.log` — путь к файлу лога.

- `--bucket-ms 200` — ширина корзины (в мс). По умолчанию 100.

- `--since, --until, --status, --grep` — те же фильтры, что и для stats/filter.

- `--json` — вывод в формате JSON (иначе — текстом).

- `--strict` — если в логах нет request_time, вернуть ненулевой код выхода.


Пример того, что идет на вход.

```
127.0.0.1 - - [10/Oct/2000:13:55:36 +0000] "GET /index.html HTTP/1.1" 200 2326 "-" "UA" 0.120
127.0.0.1 - - [10/Oct/2000:13:55:37 +0000] "GET /style.css HTTP/1.1" 200 123 "-" "UA" 0.050
127.0.0.1 - - [10/Oct/2000:13:55:40 +0000] "GET /boom HTTP/1.1" 500 0 "-" "UA" 0.900
```

Пример запуска...


```
python -m logscope hist --path access.log --bucket-ms 200
```

Ответ:

```text
      0-200: ## 2
    200-400: # 1
    800-1000: # 1
```

С `--json`:

Запрос:

```shell
python -m logscoper hist --path access.log --bucket-ms 200 --json
```

Ответ:

```json
{
  "0-200": 2,
  "200-400": 1,
  "800-1000": 1
}
```

## Как запустить?

Для начала установите библиотеку `pyinstaller`

```shell
pip install pyinstaller
```

Cоберите ее:

```shell
<ваш питон> -m pyinstaller --onefile -n logscoper -m logscoper.cli
```

После сборки бинарник окажется у вас в папке `./dist/`

Далее можем запускать

```
logscoper stats --path <путь к вашим логам>
```